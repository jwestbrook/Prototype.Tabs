/**
 * Tabs
 *
 * @author      Roland Franssen <franssen.roland@gmail.com>
 * @license     MIT
 * @version     1.0
 **/

/**
 * Mirrored at http://github.com/jwestbrook/Prototype.Tabs
 **/
var Tabs=Class.create();Object.extend(Tabs,{FIRST:"first",LAST:"last",NEXT:"next",PREV:"prev",ACTIVE:"active",Text:{FIRST:"First",LAST:"Last",NEXT:"Next",PREV:"Previous",LABEL:"New label...",CONTENT:"Default content...",LOADING:"Loading...",EMPTY:"No tabs..."},ClassNames:{CONTAINER:"tab-container",NAVIGATION:"tab-navigation",PANEL:"tabs",LI:"",CURRENT:"current",LINK:"",CONTENT:"tab",LOADING:"loading",EMPTY:"empty"}});
Object.extend(Tabs.prototype,{initialize:function(a,b){this.elm=$(a);if(Object.isElement(this.elm)){this.opt=Object.extend({start:Tabs.FIRST,rotate:!0,navigation:!0,deleteLast:!0,ajax:!1,ajaxCache:!1,ajaxOptions:{},classNames:{},event:{stop:!0,observe:"click"},text:{loading:Tabs.Text.LOADING,empty:Tabs.Text.EMPTY,content:Tabs.Text.CONTENT},callback:{afterOpen:null,afterClose:null,isEmpty:null}},b||{});this.elm.addClassName(this.cssClass("CONTAINER"));var c=this.getPanels(!0);this.opt.start=this.opt.start==
Tabs.FIRST?0:this.opt.start==Tabs.LAST||Object.isNumber(this.opt.start)&&this.opt.start>this.max?this.max:0;this.opt.navigation&&this.buildNavigation();this.isEmpty()?this.setEmpty():(c.each(function(a,b){a.LINK.observe(this.opt.event.observe,this.attachEvent.bindAsEventListener(this,b));b!=this.opt.start&&this.closePanel(b)}.bind(this)),this.openPanel(this.opt.start))}},cssClass:function(a){var b;this.opt.classNames[a]?b=this.opt.classNames[a]:Tabs.ClassNames[a]&&(b=Tabs.ClassNames[a]);return b||
""},attachEvent:function(a,b,c){this.opt.event.stop&&a.stop();this[("open close toggle reload delete add".split(" ").include(c)?c:"open")+"Panel"].call(this,b,!0)},isEmpty:function(){Object.isNumber(this.max)||this.getPanels(!0);return 0>this.max},setEmpty:function(a){a=!1===a?"show":"hide";if(this.panel&&Object.isElement(this.panel))this.panel[a]();if(this.nav&&Object.isElement(this.nav))this.nav[a]();var b=this.elm.down("div."+this.cssClass("EMPTY"));Object.isElement(b)||(b=(new Element("div",{"class":this.cssClass("EMPTY")})).update(this.opt.text.empty),
this.elm.insert(b));b["show"==a?"hide":"show"]();"hide"==a&&Object.isFunction(this.opt.callback.isEmpty)&&this.opt.callback.isEmpty.call()},buildNavigation:function(){this.nav=new Element("div",{"class":this.cssClass("NAVIGATION")});["FIRST","PREV","NEXT","LAST"].each(function(a){var b=new Element("a",{href:"javascript:;","class":"nav-"+a.toLowerCase()});this.nav.insert(b);b.update(Tabs.Text[a]).observe("click",function(){this.openPanel(Tabs[a])}.bindAsEventListener(this))}.bind(this));this.elm.insert(this.nav)},
getPanels:function(a){if(!this.panels||!0===a){this.panels=[];var b=-1;a=$w(this.cssClass("PANEL"));this.panel=this.elm.down("ul."+a.first());Object.isElement(this.panel)&&(a.each(function(a){this.panel.hasClassName(a)||this.panel.addClassName(a)}.bind(this)),this.panel.select("li").each(function(a){var d=a.down("a");if(Object.isElement(d)){var e=d.readAttribute("rel");!Object.isString(e)||!Object.isElement($(e))?(e=(new Element("div",{style:"display:none",id:Object.isString(e)?e:null})).update(this.opt.text.content),
d.writeAttribute("rel",e.identify()),this.panel.insert({after:e})):e=$(e);this.panels.push({LI:a.addClassName(this.cssClass("LI")),LINK:d.addClassName(this.cssClass("LINK")),CONTENT:e.addClassName(this.cssClass("CONTENT")),INDEX:++b})}}.bind(this)));this.max=b}return this.panels},panelByIndex:function(a){var b=this.getPanels();switch(a){case Tabs.FIRST:a=0;break;case Tabs.LAST:a=this.max;break;case Tabs.ACTIVE:a=this.active||0;break;case Tabs.NEXT:a=(this.active||0)+1;a>this.max&&this.opt.rotate&&
(a=0);break;case Tabs.PREV:a=(this.active||0)-1,0>a&&this.opt.rotate&&(a=this.max)}return Object.isNumber(a)&&0<=a&&a<=this.max?b[a]:!1},togglePanel:function(a){if(!1!==(a=this.panelByIndex(a)))this[(a.CONTENT.visible()?"close":"open")+"Panel"].call(this,a.INDEX)},openPanel:function(a,b){var c;if(!1!==(c=this.panelByIndex(a))&&this.active!=c.INDEX)Object.isNumber(this.active)&&this.closePanel(this.active),this.active=c.INDEX,c.LI.addClassName(this.cssClass("CURRENT")),c.CONTENT.show(),b&&Object.isFunction(this.opt.callback.afterOpen)&&
this.opt.callback.afterOpen.call(null,c),this.reloadPanel(c.INDEX)},closePanel:function(a,b){var c;if(!1!==(c=this.panelByIndex(a))){this.active=null;var d=this.cssClass("CURRENT"),e=this.cssClass("LOADING");c.LI.hasClassName(d)&&c.LI.removeClassName(d);c.LI.hasClassName(e)&&c.LI.removeClassName(e);c.CONTENT.hide();b&&Object.isFunction(this.opt.callback.afterClose)&&this.opt.callback.afterClose.call(null,c)}},reloadPanel:function(a){var b;if(this.opt.ajax&&!(!1===(b=this.panelByIndex(a))||!0===b.CONTENT.STATIC)){var c=
this.opt.ajax;Object.isFunction(c)&&(c=c.call(null,b));if(Object.isString(c)){if(this.opt.ajaxCache&&(this.ajaxCached||(this.ajaxCached={}),this.ajaxCached[c])){b.CONTENT.update(this.ajaxCached[c]);return}var d=this.cssClass("LOADING");b.CONTENT.addClassName(d).update(this.opt.text.loading);if(Object.isFunction(this.opt.ajaxOptions.onSuccess))var e=this.opt.ajaxOptions.onSuccess;a=Object.extend(this.opt.ajaxOptions,{onSuccess:function(a){this.ajaxCached&&(this.ajaxCached[c]=a.responseText);b.CONTENT.hasClassName(d)&&
b.CONTENT.removeClassName(d);e&&e(a)}.bind(this)});new Ajax.Updater(b.CONTENT,c,a)}}},deletePanel:function(a){if(!1!==(a=this.panelByIndex(a))&&(this.opt.deleteLast||0<this.max))a.INDEX==this.active&&this.openPanel(Tabs.NEXT),a.LI.remove(),a.CONTENT.remove(),this.getPanels(!0),this.isEmpty()&&this.setEmpty()},addPanel:function(a,b,c){this.isEmpty()&&this.setEmpty(!1);Object.isFunction(b)&&(b=b.call());var d=new Element("div",{"class":this.cssClass("CONTENT"),style:"display:none"}),e=d.identify();
Object.isArray(b)?d.each(function(a){d.insert(a)}):d.insert(b?b:this.opt.text.content);d.STATIC=!0;a=(new Element("a",{href:"javascript:;",rel:e,"class":this.cssClass("LINK")})).update(!Object.isString(a)?Tabs.Text.LABEL:a);this.panel.insert({bottom:(new Element("li")).insert(a),after:d});Object.isNumber(this.max)||this.getPanels(!0);a.observe(this.opt.event.observe,this.attachEvent.bindAsEventListener(this,this.max+1));this.getPanels(!0);if(0==this.max||!1!==c)0==this.max&&(this.active=null),this.openPanel(this.max)}});